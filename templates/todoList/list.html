{% extends "base.html" %}
{% load static %} <!-- ì •ì  íŒŒì¼(static) ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ í•„ìš”í•œ íƒœê·¸ -->

{% block content %}

<div class="todo600">
    <!-- todo ë¦¬ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°ˆ ê·¸ë¦‡ -->
    <div class="todocontainer"></div>
    <!-- Todo ë“±ë¡í•˜ê¸° ë²„íŠ¼ -->
    <button class="todoCreate todoCreate_list" onclick="window.location.href='/todoList/create/'">Todo ë“±ë¡í•˜ê¸°</button>
</div>

</div>

<!-- í˜ì´ì§€ ë²ˆí˜¸(1, 2, 3...)ê°€ ë“¤ì–´ê°ˆ ê³µê°„ -->
<div class="pagination"></div>

{% endblock %}

{% block extra_script %}
<script>
    // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜
    // ë°±ì—”ë“œì—ì„œ ì˜¤ëŠ” ISO í˜•ì‹ ë‚ ì§œ ë¬¸ìì—´ì„ ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ í˜•ì‹(ì˜ˆ: 2025.03.29 13:00)ìœ¼ë¡œ ë°”ê¿”ì¤Œ
    function datetimeToString(datetimeStr) {
        if (!datetimeStr) return "-"; // ê°’ì´ ì—†ìœ¼ë©´ í•˜ì´í”ˆ í‘œì‹œ
        const date = new Date(datetimeStr);
        return date.toLocaleString("ko-KR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
        });
    }
    
    // ë¹„ë™ê¸° ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    // ì¸ìë¡œ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ë°›ì•„ì„œ í•´ë‹¹ í˜ì´ì§€ì˜ todo ëª©ë¡ì„ ê°€ì ¸ì˜´
    function loadTodoList(page) {
        $(".todocontainer").empty(); // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

        // Axiosë¡œ API í˜¸ì¶œ (í•´ë‹¹ í˜ì´ì§€ì˜ todoë“¤ ìš”ì²­)
        axiosInstance.get(`/api/viewsets/todos/?page=${page}`) //127.0.0.1:8000/api/viewsets/todos/?page=2/
        //?page=2 ê°™ì€ êµ¬ì¡°ëŠ” "ëª©ë¡ì´ ë§ì„ ê±°ë¼ê³  ì˜ˆìƒí•˜ê³ , ë¯¸ë¦¬ ë‚˜ëˆ ì„œ ê°€ì ¸ì˜¤ë„ë¡ ì„¤ê³„ëœ API"

            //ë¹„ë™ê¸° ì²˜ë¦¬ë•Œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìš”ì²­ì´ ì„±ê³µí–ˆì„ë•Œ,
            .then(function (response) {
                const todos = response.data.results; // ì„œë²„ë¡œë¶€í„° ë°›ì€ todo ëª©ë¡

                // ê°ê°ì˜ todoë¥¼ í™”ë©´ì— í‘œì‹œ
                // forë¬¸ì€ ë¦¬ìŠ¤íŠ¸ë‚˜ ë°°ì—´ì²˜ëŸ¼ ì—¬ëŸ¬ ê°œì˜ ë°ì´í„°ë¥¼ ìˆœíšŒ(iterate)í•˜ë©´ì„œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë¨
                // ê·¸ë˜ì„œ í”íˆ "ëª¨ë“  ë°ì´í„°ë¥¼ í•œ ë²ˆì”© ì²˜ë¦¬(ë¶ˆëŸ¬ì˜¤ê¸°)" í•  ë•Œ ì‚¬ìš©.
                for (var i = 0; i < todos.length; i++) { 
                    var todo = todos[i];
                    var todoElement = `` // ë¦¬ìŠ¤íŠ¸ í•˜ë‚˜ë‹¹ HTML êµ¬ì„±

                    /*
                    âœ… ì´ forë¬¸ì˜ í•µì‹¬ ì—­í• ì€?
                    ğŸ‘‰ ëª¨ë“  todo ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©´ì„œ
                    ê° í•­ëª©ì´ ì™„ë£Œ ìƒíƒœì¸ì§€ ì•„ë‹Œì§€(ì¡°ê±´)ì— ë”°ë¼
                    ë‹¤ë¥´ê²Œ HTMLì„ êµ¬ì„±(rendering)í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.
                    */

                    // ì™„ë£Œëœ todoë¼ë©´
                    if (todo.complete === true) { //ì¡°ê±´ ëª©ë¡ë°ì´í„°ì˜ ì²´í¬ë°•ìŠ¤ì— ì²´í¬ì˜ ì •ë³´ê°€ trueì¼ê²½ìš°
                        todoElement = `          
                    <div class="todo-item" onclick="detailView(${todo.id})">
                        <p><strong>Name:</strong>${todo.name}</p>
                        <p><strong>Description:</strong> ${todo.description}</p>
                        <p class="complete_underline"><strong>Complete:</strong> ${todo.complete ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘"}</p>
                        <p><strong>Completed At:</strong> ${datetimeToString(todo.completed_at)}</p>
                        <p><strong>Experience Points:</strong> ${todo.exp}</p>
                    </div>
                    `
                    } else { // ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ todoë¼ë©´, ì™„ë£Œ ë²„íŠ¼ë„ ì¶”ê°€
                        todoElement = `
                    <div class="todo-item" onclick="detailView(${todo.id})">
                        <p><strong>Name:</strong>${todo.name}</p>
                        <p><strong>Description:</strong> ${todo.description}</p>
                        <p><strong>Complete:</strong> ${todo.complete ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘"}</p>
                        <p><strong>Completed At:</strong> ${datetimeToString(todo.completed_at)}</p>
                        <p><strong>Experience Points:</strong> ${todo.exp}</p>
                        <button class="todoUpdate" onclick="toComplete(${todo.id})">ì™„ë£Œ</button>
                    </div>
                    `
                    }

                    // ë§Œë“¤ì–´ì§„ HTMLì„ .todocontainer div ì•ˆì— ì¶”ê°€
                    $(".todocontainer").append(todoElement)
                }


                // í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬ ì‹œì‘
                var pagination = response.data;
                var pageLinks = "";

                const totalCount = pagination.count; // ì „ì²´ todo ê°œìˆ˜
                const totalPages = Math.ceil(totalCount / 5); // í•œ í˜ì´ì§€ì— 5ê°œì”© ë³´ì—¬ì¤„ ë•Œ ì´ í˜ì´ì§€ ìˆ˜ ê³„ì‚°

                if (totalPages > 1) {
                    var maxDisplayedPages = 5; // ìµœëŒ€ í‘œì‹œí•  í˜ì´ì§€ ë²ˆí˜¸ ìˆ˜
                    var currentPage = page;

                    var startPage = Math.max(1, currentPage - 5);
                    var endPage = Math.min(totalPages, currentPage + 5);

                    // í˜ì´ì§€ ë§í¬ ê³„ì‚° ë³´ì •
                    if (currentPage - startPage < 5) {
                        endPage = Math.min(endPage + (5 - (currentPage - startPage)), totalPages);
                    }
                    if (endPage - currentPage < 5) {
                        startPage = Math.max(startPage - (5 - (endPage - currentPage)), 1);
                    }

                    // í˜ì´ì§€ ë²ˆí˜¸ ë§í¬ë¥¼ í•˜ë‚˜ì”© ìƒì„±í•´ì„œ pageLinks ë¬¸ìì—´ì— ì¶”ê°€
                    for (var i = startPage; i <= endPage; i++) {
                        pageLinks += `<a class="listNum" href="#" onclick="loadTodoList(${i})">${i}</a> `;
                    }

                    // í˜ì´ì§€ ë²ˆí˜¸ ë§í¬ë“¤ì„ .pagination divì— ì‚½ì…
                    $(".pagination").html(pageLinks);
                }

            })

            //ìš”ì²­ì´ ì‹¤íŒ¨í–ˆì„ë•Œ(ì—ëŸ¬ë°œìƒ)
            .catch(function (error) {
                console.log(error) // ì—ëŸ¬ ë°œìƒ ì‹œ ì½˜ì†”ì— ì¶œë ¥
            })

    }

    // ìƒì„¸ í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
    // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í´ë¦­ ì‹œ í˜¸ì¶œë¨ â†’ í•´ë‹¹ Todoì˜ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function detailView(pk) {
        window.location.href = `/todoList/detail/${pk}/`; //127.0.0.1:8000/todoList/detail/id/
    }
    
    // ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë¨ â†’ ì™„ë£Œ ì²˜ë¦¬ ìš”ì²­
    function toComplete(pk) {
        axiosInstance.patch(`/api/viewsets/todos/${pk}/`,
            {
                complete: true,
            })
            .then(function (response) {
                window.location.reload()
            })
    }
    
    //í˜ì´ì§€ ë¡œë”© ì‹œ ì‹¤í–‰ë˜ëŠ” ë¶€ë¶„
    $(document).ready(function () {
        loadTodoList(1);
    });    

</script>
{% endblock %}