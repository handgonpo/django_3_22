{% extends "base.html" %}
{% load static %} <!-- ì •ì  íŒŒì¼(static)ì„ HTMLì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” íƒœê·¸ -->
<link rel="stylesheet" href="{% static 'css/style.css' %}">

{% block content %} <!-- âœ… ìƒì„¸ í˜ì´ì§€ì˜ ë³¸ë¬¸ ì˜ì—­ ì‹œì‘ -->
<div class="todoDetail todo600">
    
    <!-- ğŸ”™ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (Todo ëª©ë¡ìœ¼ë¡œ ì´ë™) -->
    <button class="toList todoCreate" onclick="window.location.href='/todoList/list/'">ë’¤ë¡œê°€ê¸°</button>
    
    <div class="todoInfo"></div> <!-- âœ… ì´ê³³ì— ìƒì„¸ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ë“¤ì–´ì˜¬ ì˜ˆì • -->
    
    <!-- âœï¸ ìˆ˜ì • / ğŸ—‘ ì‚­ì œ ë²„íŠ¼ -->
    {% if user.is_authenticated %} 
    <div class="btnList">
        <button class="todoUpdate todoCreate" onclick="toUpdate()">ìˆ˜ì •</button>
        <button class="todoDelete todoCreate" onclick="toDelete()">ì‚­ì œ</button>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block extra_script %}
<script>
    // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜: ë‚ ì§œë¥¼ ë³´ê¸° ì¢‹ê²Œ ë°”ê¿”ì£¼ëŠ” í•¨ìˆ˜
    // ë°±ì—”ë“œì—ì„œ ì˜¤ëŠ” ISO í˜•ì‹ ë‚ ì§œ ë¬¸ìì—´ì„ ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ í˜•ì‹(ì˜ˆ: 2025.03.29 13:00)ìœ¼ë¡œ ë°”ê¿”ì¤Œ
    // ì˜ˆ: 2025-03-24T10:00:00 â†’ 2025.03.24 ì˜¤ì „ 10:00
    function datetimeToString(datetimeStr) {
        if (!datetimeStr) return "-"; // ê°’ì´ ì—†ìœ¼ë©´ í•˜ì´í”ˆ"_" í‘œì‹œ
        const date = new Date(datetimeStr);
        return date.toLocaleString("ko-KR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
        });
    }


    // 127.0.0.1:8000/todoList/detail/pk/ http
    // 127.0.0.1:8000/api/viewsets/todos/pk/ insomnia
    $(document).ready(function(){
        // í˜„ì¬ URLì—ì„œ pk(ê¸€ ë²ˆí˜¸)ë§Œ ì¶”ì¶œ
        const urlParts = window.location.pathname.split('/').filter(Boolean);
        const pk = urlParts[urlParts.length - 1];//ê¸€ë²ˆí˜¸(pk)ì¶”ì¶œ
        /*
       ì˜ˆë¥¼ë“¤ì–´ http://127.0.0.1:8000/todoList/detail/3/ 3ë²ˆì§¸ê¸€ ì¶”ì¶œ
       "/todoList/detail/3/"
       split('/')ë¡œ / ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ ë³´ë©´?: ["", "todoList", "detail", "3", ""]
       filter(Boolean)ì€? ë¹ˆ ë¬¸ìì—´("")ì„ ì œê±°í•´ì¤ë‹ˆë‹¤. ["todoList", "detail", "3"]
       urlParts.length - 1? urlParts.lengthëŠ” 3, ë§ˆì§€ë§‰ ìš”ì†Œì˜ ì¸ë±ìŠ¤ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë‹ˆ 3ê°œì¤‘ 2ê°€ ë˜ê³ 
       -1ì„ í•´ì¤€ê²ƒì„ ì¸ë±ìŠ¤ê°€ 0ë¶€í„°ì´ê¸° ë•Œë¬¸
        */
        
        // ìƒì„¸ ì¡°íšŒ API ìš”ì²­: âœ… ë°±ì—”ë“œ APIë¡œ í•´ë‹¹ pkì˜ Todo ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
        axiosInstance.get(`/api/viewsets/todos/${pk}/`)
        .then(function(response){
            const todo = response.data;
            console.log("ë°›ì•„ì˜¨ todo:", todo); // ë°›ì•„ì˜¨ ë°ì´í„°

            // âœ… ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œ (HTML êµ¬ì„±)
            $(".todoInfo").append(`
                <div class="todo-item">
                    <p><strong>Name:</strong>${todo.name}</p>
                    <p><strong>Description:</strong> </p>
                    <div>${todo.description}</div>
                    <p><strong>Complete:</strong> ${ todo.complete ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘" }</p>
                    <p><strong>Completed At:</strong> ${datetimeToString(todo.completed_at)}</p>
                    <p><strong>Experience Points:</strong> ${ todo.exp }</p>
                </div>
            `)
            }
        )
        .catch(function(error){

            // âŒ ì—ëŸ¬ ë°œìƒ ì‹œ ì•Œë¦¼ì„ ë„ìš°ê³  ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
            console.log(error);
            alert("í•´ë‹¹ Todo ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            window.location.href = "/todoList";
            //window.location.href = "127.0.0.1:8000/todoList/detail/pk/";
        });
    });
    
    // âœï¸ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ â†’ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
    function toUpdate(){
        const urlParts = window.location.pathname.split('/').filter(Boolean);
        //console.log("âœ… urlParts:", urlParts);
        
        const pk = urlParts[urlParts.length - 1]; // í˜„ì¬ ê¸€ ë²ˆí˜¸
        //console.log("âœ… ì¶”ì¶œëœ pk:", pk);
        
        window.location.href = `/todoList/update/${pk}/`;// ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
    }

    // ğŸ—‘ ì‚­ì œ ë²„íŠ¼ í´ë¦­ â†’ ì‚­ì œ API í˜¸ì¶œ
    function toDelete(){
        const urlParts = window.location.pathname.split('/').filter(Boolean);
        const pk = urlParts[urlParts.length - 1]; // í˜„ì¬ ê¸€ ë²ˆí˜¸

        // ì‚¬ìš©ì í™•ì¸ì°½
        if (confirm("ì •ë§ í•´ë‹¹ Todoë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){

            // âœ… ì‚­ì œ ìš”ì²­
            axiosInstance.delete(`/api/viewsets/todos/${pk}/`) //insomnia ê²½ë¡œ
            .then(function(response){

                // ì‚­ì œ í›„ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = "/todoList/list/";
            })
            .catch(function(error){
                alert("Todo ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }
    }

</script>
{% endblock %}
