{% extends "base.html" %}  <!-- base.html í…œí”Œë¦¿ì„ í™•ì¥ (ê³µí†µ ë ˆì´ì•„ì›ƒ ì‚¬ìš©) -->

{% load static %}  <!-- ì •ì (static) íŒŒì¼ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ static í…œí”Œë¦¿ íƒœê·¸ ë¶ˆëŸ¬ì˜´ -->

{% block content %}
<div class="container todo600">
    <h2>Update Your Todo</h2>

    <!-- ğŸ”¹ Todo ì´ë¦„ ì…ë ¥ í•„ë“œ -->
    <div>
        <label for="name">Name:</label>
        <input type="text" name="name" id="name">
    </div>

    <!-- ğŸ”¹ Todo ì„¤ëª… ì…ë ¥ í•„ë“œ (CKEditorê°€ ì ìš©ë  textarea) -->
    <div>
        <label for="description">Description:</label>
        <textarea name="description" id="description"></textarea>
    </div>

    <!-- ğŸ”¹ ì™„ë£Œ ì—¬ë¶€ ì²´í¬ë°•ìŠ¤ -->
    <div>
        <label for="complete">Complete:</label>
        <input type="checkbox" name="complete" id="complete">
    </div>

    <!-- ğŸ”¹ ê²½í—˜ì¹˜ ì…ë ¥ í•„ë“œ -->
    <div>
        <label for="exp">Experience Points:</label>
        <input type="number" name="exp" id="exp" min="0">
    </div>

    <!-- ğŸ”¹ ì—…ë°ì´íŠ¸ ë²„íŠ¼ -->
    <button class="todoCreate todoCreate_list" type="submit" id="todoUpdate">Update</button>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // ğŸ“Œ CKEditor ì´ˆê¸°í™”: description textareaë¥¼ ë©‹ì§„ ì—ë””í„°ë¡œ ë°”ê¿”ì¤Œ
    CKEDITOR.replace('description');

    // ğŸ“Œ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë  í•¨ìˆ˜
    $(document).ready(function(){
        // âœ… í˜„ì¬ í˜ì´ì§€ URLì—ì„œ pk(ê¸€ ë²ˆí˜¸)ë§Œ ì¶”ì¶œ
        let pk = window.location.href.split('/').filter(Boolean).pop();

        // âœ… ë°±ì—”ë“œ APIì— ìš”ì²­í•´ì„œ í•´ë‹¹ pkì˜ Todo ë°ì´í„°ë¥¼ ë°›ì•„ì˜´
        axiosInstance.get(`/api/viewsets/todos/${pk}/`)
        .then(function(response){
            const todo = response.data;

            // âœ… ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ê° input ìš”ì†Œì— ì±„ì›Œë„£ìŒ
            $("#name").val(todo.name);                       // ì´ë¦„
            $("#complete").prop("checked", todo.complete);   // ì™„ë£Œ ì—¬ë¶€
            $("#exp").val(todo.exp);                         // ê²½í—˜ì¹˜

            // âœ… ì„¤ëª…ì€ CKEditor ì—ë””í„° ì•ˆì— ë„£ì–´ì•¼ í•˜ë¯€ë¡œ setData ì‚¬ìš©!
            CKEDITOR.instances['description'].setData(todo.description);
        });
    });

    // ğŸ“Œ [Update] ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  ì½”ë“œ
    $("#todoUpdate").on("click", function() {
        // âœ… ë‹¤ì‹œ pk(ê¸€ ë²ˆí˜¸) ì¶”ì¶œ
        let pk = window.location.href.split('/').filter(Boolean).pop();

        // âœ… CKEditorì—ì„œ ì…ë ¥ëœ ì„¤ëª… ë‚´ìš©ì„ ê°€ì ¸ì˜´
        let description = CKEDITOR.instances['description'].getData();

        let name = $("#name").val();
        let exp = $("#exp").val();  
        
        // âœ… ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
        if (name.trim() === "") {
            alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (description.trim() === "") {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (exp === "") {
            exp = 0;
        }    


        // âœ… ë°±ì—”ë“œ APIì— ìˆ˜ì • ìš”ì²­(PATCH) ë³´ë‚´ê¸°
        axiosInstance.patch(`/api/viewsets/todos/${pk}/`, {
            name: $("#name").val(),                          // ì´ë¦„
            description: description,                        // ì„¤ëª…
            complete: $("#complete").prop("checked"),        // ì™„ë£Œ ì—¬ë¶€
            exp: $("#exp").val(),                            // ê²½í—˜ì¹˜
        })
        .then(function(response) {
            // âœ… ìˆ˜ì • ì„±ê³µ ì‹œ, í•´ë‹¹ Todoì˜ ìƒì„¸ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/todoList/detail/${pk}/`;
        })
        .catch(function(error) {
            // âŒ ìˆ˜ì • ì‹¤íŒ¨ ì‹œ ì½˜ì†”ì— ì—ëŸ¬ ì¶œë ¥ + ì•Œë¦¼ì°½
            console.log(error);
            alert("Todo ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    });
</script>
{% endblock %}
