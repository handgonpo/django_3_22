# 워커 프로세스 자동 설정 (CPU 코어 수만큼)
worker_processes auto;

events {
    # 이벤트 블록은 최소 설정 유지
}

http {
    # 🔸 HTTP (포트 80) 설정: 개발용 IP 접속 지원
    server {
        listen 80;
        server_name localhost; # 개발 시에는 localhost 또는 EC2의 퍼블릭 IP

        include mime.types;

        # 정적 파일 서빙: http://<IP>/static/ → /data/static/ 폴더 참조
        location /static/ {
            alias /data/static/;
        }

        # 실제 서비스 시 HTTP → HTTPS 리디렉션 (지금은 주석처리 해도 됨)
        # location / {
        #     return 301 https://$host$request_uri;
        # }


        # 개발 중엔 아래처럼 프록시로 바로 Django 접속 가능하도록 설정 (도메인 없어도 됨)
        location / {
            proxy_pass http://django_container:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            send_timeout 60s;
        }

    }

    # HTTPS (포트 443) 설정: 도메인 + 인증서 발급 후에 사용
    server {
        listen 443 ssl http2;
        server_name localhost; # 도메인 연결 후 사용

        # 보안 프로토콜: TLS 1.2 이상만 허용 (최신 기준)
        ssl_protocols TLSv1.2 TLSv1.3;

        # ssl_certificate /etc/letsencrypt/live/updaun.store/fullchain.pem;
        # ssl_certificate_key /etc/letsencrypt/live/updaun.store/privkey.pem;

        include mime.types;
        
        # 정적 파일 서빙
        location /static/ {
            alias /data/static/;
        }

        # Django 앱에 프록시 연결
        location / {
            proxy_pass http://django_container:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            send_timeout 60s;
        }
    }
}